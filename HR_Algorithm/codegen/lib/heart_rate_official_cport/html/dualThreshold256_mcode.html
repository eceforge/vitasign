<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,743" id="srcline743">743</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,744" id="srcline744">744</a></span><span class="line"><span class="comment">%DUAL THRESHOLD PROCESSSING</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,745" id="srcline745">745</a></span><span class="line"><span class="comment">% Filters out R_peaks which don't meet the threshold reqs</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,746" id="srcline746">746</a></span><span class="line">    <span class="keyword">function</span> [<span class="var type1" id="S94T59U1394">indices</span>, <span class="var type1" id="S95T7U1395">noise_lvl</span>, <span class="var type1" id="S96T7U1396">signal_lvl</span>] = dualThreshold(<span class="var type1" id="S97T58U1399">R_peak_vals</span>, <span class="var type1" id="S98T7U1400">threshold</span>, <span class="mxinfo" id="T59:U6"><span class="mxinfo" id="T59:U7"><span class="var type1" id="S94T59U1401">indices</span></span></span>, <span class="var type1" id="S99T7U1402">max_voltage</span>, <span class="var type1" id="S100T7U1403">pos_deviance_threshold</span>, <span class="var type1" id="S101T7U1404">neg_deviance_threshold</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,747" id="srcline747">747</a></span><span class="line">        <span class="mxinfo" id="T8:U12"><span class="var type1" id="S102T8U1407">Fixed_Point_Properties</span> = <span class="mxinfo" id="T8:U14">numerictype(<span class="string">'WordLength'</span>, 32, <span class="string">'FractionLength'</span>, 10, <span class="string">'Signed'</span>,false)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,748" id="srcline748">748</a></span><span class="line">        <span class="mxinfo" id="T9:U15"><span class="var type1" id="S105T9U1419">F</span> = <span class="mxinfo" id="T9:U17">fimath(<span class="string">'OverflowMode'</span>,<span class="string">'saturate'</span>, <span class="string">'RoundMode'</span>, <span class="string">'nearest'</span>, <span class="string">'ProductFractionLength'</span>, 20,<span class="string">'ProductMode'</span>, <span class="string">'SpecifyPrecision'</span>, <span class="string">'MaxProductWordLength'</span>, 32, <span class="string">'SumFractionLength'</span>, 10, <span class="string">'SumMode'</span>, <span class="string">'SpecifyPrecision'</span>,<span class="string">'MaxSumWordLength'</span>, 32)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,749" id="srcline749">749</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,750" id="srcline750">750</a></span><span class="line">        <span class="comment">% asserts that the input parameters are of fixed point</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,751" id="srcline751">751</a></span><span class="line">        assert(isfi(<span class="var type1" id="S97T58U1443">R_peak_vals</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,752" id="srcline752">752</a></span><span class="line">        assert(isfi(<span class="var type1" id="S98T7U1449">threshold</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,753" id="srcline753">753</a></span><span class="line">        assert(isa(<span class="var type1" id="S94T59U1455">indices</span>,<span class="string">'uint32'</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,754" id="srcline754">754</a></span><span class="line">        assert(isfi(<span class="var type1" id="S99T7U1462">max_voltage</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,755" id="srcline755">755</a></span><span class="line">        assert(isfi(<span class="var type1" id="S100T7U1468">pos_deviance_threshold</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,756" id="srcline756">756</a></span><span class="line">        assert(isfi(<span class="var type1" id="S101T7U1474">neg_deviance_threshold</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,757" id="srcline757">757</a></span><span class="line">        <span class="comment">% asserts that input parameters are of specific fixed point parameters</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,758" id="srcline758">758</a></span><span class="line">        assert(<span class="mxinfo" id="T6:U24">isequal(numerictype(<span class="var type1" id="S97T58U1483">R_peak_vals</span>), <span class="var type1" id="S102T8U1484">Fixed_Point_Properties</span>) &amp;&amp; isequal(fimath(<span class="var type1" id="S97T58U1489">R_peak_vals</span>), <span class="var type1" id="S105T9U1490">F</span>)</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,759" id="srcline759">759</a></span><span class="line">        assert(<span class="mxinfo" id="T6:U29">isequal(numerictype(<span class="var type1" id="S98T7U1499">threshold</span>), <span class="var type1" id="S102T8U1500">Fixed_Point_Properties</span>) &amp;&amp; isequal(fimath(<span class="var type1" id="S98T7U1505">threshold</span>), <span class="var type1" id="S105T9U1506">F</span>)</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,760" id="srcline760">760</a></span><span class="line">        assert(<span class="mxinfo" id="T6:U34">isequal(numerictype(<span class="var type1" id="S99T7U1515">max_voltage</span>), <span class="var type1" id="S102T8U1516">Fixed_Point_Properties</span>) &amp;&amp; isequal(fimath(<span class="var type1" id="S99T7U1521">max_voltage</span>), <span class="var type1" id="S105T9U1522">F</span>)</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,761" id="srcline761">761</a></span><span class="line">        assert(<span class="mxinfo" id="T6:U39">isequal(numerictype(<span class="var type1" id="S100T7U1531">pos_deviance_threshold</span>), <span class="var type1" id="S102T8U1532">Fixed_Point_Properties</span>) &amp;&amp; isequal(fimath(<span class="var type1" id="S100T7U1537">pos_deviance_threshold</span>), <span class="var type1" id="S105T9U1538">F</span>)</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,762" id="srcline762">762</a></span><span class="line">        assert(<span class="mxinfo" id="T6:U44">isequal(numerictype(<span class="var type1" id="S101T7U1547">neg_deviance_threshold</span>), <span class="var type1" id="S102T8U1548">Fixed_Point_Properties</span>) &amp;&amp; isequal(fimath(<span class="var type1" id="S101T7U1553">neg_deviance_threshold</span>), <span class="var type1" id="S105T9U1554">F</span>)</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,763" id="srcline763">763</a></span><span class="line">        <span class="mxinfo" id="T7:U49"><span class="var type1" id="S111T7U1557">noise_sum</span> = <span class="mxinfo" id="T7:U51">fi(0, <span class="var type1" id="S102T8U1561">Fixed_Point_Properties</span>, <span class="var type1" id="S105T9U1562">F</span>)</span></span>; <span class="mxinfo" id="T7:U54"><span class="var type1" id="S113T7U1565">signal_sum</span> = <span class="mxinfo" id="T7:U56">fi(0, <span class="var type1" id="S102T8U1569">Fixed_Point_Properties</span>, <span class="var type1" id="S105T9U1570">F</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,764" id="srcline764">764</a></span><span class="line">        <span class="mxinfo" id="T7:U59"><span class="var type1" id="S114T7U1573">noise_count</span> = <span class="mxinfo" id="T7:U61">fi(0, <span class="var type1" id="S102T8U1577">Fixed_Point_Properties</span>, <span class="var type1" id="S105T9U1578">F</span>)</span></span>; <span class="mxinfo" id="T7:U64"><span class="var type1" id="S115T7U1581">signal_count</span> = <span class="mxinfo" id="T7:U66">fi(0, <span class="var type1" id="S102T8U1585">Fixed_Point_Properties</span>, <span class="var type1" id="S105T9U1586">F</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,765" id="srcline765">765</a></span><span class="line">        <span class="mxinfo" id="T7:U69"><span class="var type1" id="S95T7U1589">noise_lvl</span> = <span class="mxinfo" id="T7:U71">fi(0, <span class="var type1" id="S102T8U1593">Fixed_Point_Properties</span>, <span class="var type1" id="S105T9U1594">F</span>)</span></span>; <span class="mxinfo" id="T7:U74"><span class="var type1" id="S96T7U1597">signal_lvl</span> = <span class="mxinfo" id="T7:U76">fi(0,<span class="var type1" id="S102T8U1601">Fixed_Point_Properties</span>, <span class="var type1" id="S105T9U1602">F</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,766" id="srcline766">766</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,767" id="srcline767">767</a></span><span class="line">        <span class="keyword">for</span> <span class="var type1" id="S116T2U1605">index</span>=<span class="mxinfo" id="T2:U80">1</span>:<span class="mxinfo" id="T2:U81">length(<span class="var type1" id="S97T58U1610">R_peak_vals</span>)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,768" id="srcline768">768</a></span><span class="line">               <span class="comment">% DELETE AFTER DEBUGGING</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,769" id="srcline769">769</a></span><span class="line">               <span class="comment">%if (shouldPlot &amp;&amp; channel == 2)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,770" id="srcline770">770</a></span><span class="line">               <span class="comment">%    fprintf('The peak val is: %f\n',R_peak_vals(index));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,771" id="srcline771">771</a></span><span class="line">               <span class="comment">%end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,772" id="srcline772">772</a></span><span class="line">           <span class="keyword">if</span> (<span class="mxinfo" id="T6:U83"><span class="mxinfo" id="T44:U84"><span class="mxinfo" id="T7:U85"><span class="var type1" id="S97T58U1617">R_peak_vals</span>(<span class="var type1" id="S116T2U1618">index</span>)</span> * <span class="var type1" id="S99T7U1619">max_voltage</span></span> &gt; <span class="var type1" id="S98T7U1620">threshold</span></span>) </span></span>
<span class="srcline"><span class="lineno"><a href="1,773" id="srcline773">773</a></span><span class="line">               <span class="comment">%fprintf('mv: %f. Threshold is: %f\n', R_peak_vals(index) * max_voltage, threshold);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,774" id="srcline774">774</a></span><span class="line">               <span class="comment">%R_peak_vals(index)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,775" id="srcline775">775</a></span><span class="line">               </span></span>
<span class="srcline"><span class="lineno"><a href="1,776" id="srcline776">776</a></span><span class="line">               <span class="comment">% Filters out any signal value which exceeds the allowed deviance from</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,777" id="srcline777">777</a></span><span class="line">               <span class="comment">% the average signal value </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,778" id="srcline778">778</a></span><span class="line">               <span class="keyword">if</span> (<span class="mxinfo" id="T6:U90">~<span class="mxinfo" id="T6:U91"><span class="fcn" id="F270N4:B1626">meets_deviance_threshold</span>(<span class="mxinfo" id="T7:U92"><span class="var type1" id="S97T58U1628">R_peak_vals</span>(<span class="var type1" id="S116T2U1629">index</span>)</span>, <span class="var type1" id="S96T7U1630">signal_lvl</span>, <span class="var type1" id="S100T7U1631">pos_deviance_threshold</span>, <span class="var type1" id="S101T7U1632">neg_deviance_threshold</span>)</span></span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,779" id="srcline779">779</a></span><span class="line"><span class="comment">%                   fprintf('%f, %f Does not meet the deviance threshold\n', R_peak_vals(index), signal_lvl);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,780" id="srcline780">780</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,781" id="srcline781">781</a></span><span class="line">                   <span class="comment">% Sets all the indices which R_vals don't meet the threshold to 0</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,782" id="srcline782">782</a></span><span class="line">                   <span class="mxinfo" id="T3:U98"><span class="mxinfo" id="T3:U99"><span class="var type1" id="S94T59U1636">indices</span>(<span class="var type1" id="S116T2U1637">index</span>)</span> = <span class="mxinfo" id="T2:U102">0</span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="1,783" id="srcline783">783</a></span><span class="line">                   </span></span>
<span class="srcline"><span class="lineno"><a href="1,784" id="srcline784">784</a></span><span class="line">                   <span class="comment">% Updates the average noise signal lvl</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,785" id="srcline785">785</a></span><span class="line">                   <span class="mxinfo" id="T7:U103"><span class="var type1" id="S111T7U1641">noise_sum</span> = <span class="mxinfo" id="T7:U105"><span class="var type1" id="S111T7U1643">noise_sum</span>  + <span class="mxinfo" id="T7:U107"><span class="var type1" id="S97T58U1645">R_peak_vals</span>(<span class="var type1" id="S116T2U1646">index</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,786" id="srcline786">786</a></span><span class="line">                   <span class="mxinfo" id="T7:U110"><span class="var type1" id="S114T7U1649">noise_count</span> = <span class="mxinfo" id="T7:U112"><span class="var type1" id="S114T7U1651">noise_count</span> + 1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,787" id="srcline787">787</a></span><span class="line">                   </span></span>
<span class="srcline"><span class="lineno"><a href="1,788" id="srcline788">788</a></span><span class="line">                   <span class="comment">% Calculates the noise level</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,789" id="srcline789">789</a></span><span class="line"><span class="comment">%                    noise_lvl = noise_sum / noise_count;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,790" id="srcline790">790</a></span><span class="line">                   <span class="mxinfo" id="T7:U114"><span class="var type1" id="S95T7U1655">noise_lvl</span> = <span class="mxinfo" id="T7:U116">divide(<span class="var type1" id="S102T8U1658">Fixed_Point_Properties</span>, <span class="var type1" id="S111T7U1659">noise_sum</span>, <span class="var type1" id="S114T7U1660">noise_count</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,791" id="srcline791">791</a></span><span class="line">                   <span class="keyword">continue</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,792" id="srcline792">792</a></span><span class="line">               <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,793" id="srcline793">793</a></span><span class="line">               <span class="comment">% DELETE AFTER DEBUGGING</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,794" id="srcline794">794</a></span><span class="line">               <span class="comment">%if (shouldPlot &amp;&amp; channel == 2)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,795" id="srcline795">795</a></span><span class="line">               <span class="comment">%   fprintf('The peak val is: %f\n',R_peak_vals(index));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,796" id="srcline796">796</a></span><span class="line">               <span class="comment">%end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,797" id="srcline797">797</a></span><span class="line">               </span></span>
<span class="srcline"><span class="lineno"><a href="1,798" id="srcline798">798</a></span><span class="line">                <span class="comment">% Updates the average signal lvl</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,799" id="srcline799">799</a></span><span class="line">               <span class="mxinfo" id="T7:U120"><span class="var type1" id="S113T7U1664">signal_sum</span> = <span class="mxinfo" id="T7:U122"><span class="var type1" id="S113T7U1666">signal_sum</span> + <span class="mxinfo" id="T7:U124"><span class="var type1" id="S97T58U1668">R_peak_vals</span>(<span class="var type1" id="S116T2U1669">index</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,800" id="srcline800">800</a></span><span class="line">               <span class="mxinfo" id="T7:U127"><span class="var type1" id="S115T7U1672">signal_count</span> = <span class="mxinfo" id="T7:U129"><span class="var type1" id="S115T7U1674">signal_count</span> + 1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,801" id="srcline801">801</a></span><span class="line">               </span></span>
<span class="srcline"><span class="lineno"><a href="1,802" id="srcline802">802</a></span><span class="line">               <span class="comment">% Calculates the signal level</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,803" id="srcline803">803</a></span><span class="line">               <span class="mxinfo" id="T7:U131"><span class="var type1" id="S96T7U1678">signal_lvl</span> = <span class="mxinfo" id="T7:U133">divide(<span class="var type1" id="S102T8U1681">Fixed_Point_Properties</span>, <span class="var type1" id="S113T7U1682">signal_sum</span>, <span class="var type1" id="S113T7U1683">signal_sum</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,804" id="srcline804">804</a></span><span class="line">           <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,805" id="srcline805">805</a></span><span class="line">               <span class="comment">% Sets all the indices which R_vals don't meet the threshold to 0</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,806" id="srcline806">806</a></span><span class="line">               <span class="mxinfo" id="T3:U137"><span class="mxinfo" id="T3:U138"><span class="var type1" id="S94T59U1688">indices</span>(<span class="var type1" id="S116T2U1689">index</span>)</span> = <span class="mxinfo" id="T2:U141">0</span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="1,807" id="srcline807">807</a></span><span class="line">               <span class="comment">% Updates the average noise signal lvl</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,808" id="srcline808">808</a></span><span class="line">               <span class="mxinfo" id="T7:U142"><span class="var type1" id="S111T7U1693">noise_sum</span> = <span class="mxinfo" id="T7:U144"><span class="var type1" id="S111T7U1695">noise_sum</span>  + <span class="mxinfo" id="T7:U146"><span class="var type1" id="S97T58U1697">R_peak_vals</span>(<span class="var type1" id="S116T2U1698">index</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,809" id="srcline809">809</a></span><span class="line">               <span class="mxinfo" id="T7:U149"><span class="var type1" id="S114T7U1701">noise_count</span> = <span class="mxinfo" id="T7:U151"><span class="var type1" id="S114T7U1703">noise_count</span> + 1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,810" id="srcline810">810</a></span><span class="line">               <span class="comment">% Calculates the noise level</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,811" id="srcline811">811</a></span><span class="line"><span class="comment">%                noise_lvl = noise_sum / noise_count;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,812" id="srcline812">812</a></span><span class="line">               <span class="mxinfo" id="T7:U153"><span class="var type1" id="S95T7U1707">noise_lvl</span> = <span class="mxinfo" id="T7:U155">divide(<span class="var type1" id="S102T8U1710">Fixed_Point_Properties</span>, <span class="var type1" id="S111T7U1711">noise_sum</span>, <span class="var type1" id="S114T7U1712">noise_count</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,813" id="srcline813">813</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,814" id="srcline814">814</a></span><span class="line">           <span class="keyword">end</span>          </span></span>
<span class="srcline"><span class="lineno"><a href="1,815" id="srcline815">815</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,816" id="srcline816">816</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,817" id="srcline817">817</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,818" id="srcline818">818</a></span><span class="line"><span class="comment">% Level 4 Detection: Reduces FNs by comparing Ds(detection strength) against</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,819" id="srcline819">819</a></span><span class="line"><span class="comment">% the threshold</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,820" id="srcline820">820</a></span><span class="line"><span class="comment">%R_peak_indices_combined</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,821" id="srcline821">821</a></span><span class="line"><span class="comment">% FOURTH LEVEL PROCESSING TO REDUCE FNs</span></span></span>
</pre>
