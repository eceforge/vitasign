<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,689" id="srcline689">689</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,690" id="srcline690">690</a></span><span class="line"><span class="comment">%DUAL THRESHOLD PROCESSSING</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,691" id="srcline691">691</a></span><span class="line"><span class="comment">% Filters out R_peaks which don't meet the threshold reqs</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,692" id="srcline692">692</a></span><span class="line">    <span class="keyword">function</span> [<span class="var type1" id="S88T73U1261">indices</span>, <span class="var type1" id="S89T7U1262">noise_lvl</span>, <span class="var type1" id="S90T7U1263">signal_lvl</span>] = dualThreshold(<span class="var type1" id="S91T71U1266">R_peak_vals</span>, <span class="var type1" id="S92T7U1267">threshold</span>, <span class="mxinfo" id="T73:U6"><span class="mxinfo" id="T73:U7"><span class="var type1" id="S88T73U1268">indices</span></span></span>, <span class="var type1" id="S93T7U1269">max_voltage</span>, <span class="var type1" id="S94T7U1270">pos_deviance_threshold</span>, <span class="var type1" id="S95T7U1271">neg_deviance_threshold</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,693" id="srcline693">693</a></span><span class="line">        <span class="mxinfo" id="T8:U12"><span class="var type1" id="S96T8U1274">Fixed_Point_Properties</span> = <span class="mxinfo" id="T8:U14">numerictype(<span class="string">'WordLength'</span>, 32, <span class="string">'FractionLength'</span>, 10, <span class="string">'Signed'</span>,false)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,694" id="srcline694">694</a></span><span class="line">        <span class="mxinfo" id="T9:U15"><span class="var type1" id="S99T9U1286">F</span> = <span class="mxinfo" id="T9:U17">fimath(<span class="string">'OverflowMode'</span>,<span class="string">'saturate'</span>, <span class="string">'RoundMode'</span>, <span class="string">'nearest'</span>, <span class="string">'ProductFractionLength'</span>, 20,<span class="string">'ProductMode'</span>, <span class="string">'SpecifyPrecision'</span>, <span class="string">'MaxProductWordLength'</span>, 32, <span class="string">'SumFractionLength'</span>, 10, <span class="string">'SumMode'</span>, <span class="string">'SpecifyPrecision'</span>,<span class="string">'MaxSumWordLength'</span>, 32)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,695" id="srcline695">695</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,696" id="srcline696">696</a></span><span class="line">        <span class="comment">% asserts that the input parameters are of fixed point</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,697" id="srcline697">697</a></span><span class="line">        assert(isfi(<span class="var type1" id="S91T71U1310">R_peak_vals</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,698" id="srcline698">698</a></span><span class="line">        assert(isfi(<span class="var type1" id="S92T7U1316">threshold</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,699" id="srcline699">699</a></span><span class="line">        assert(isa(<span class="var type1" id="S88T73U1322">indices</span>,<span class="string">'uint32'</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,700" id="srcline700">700</a></span><span class="line">        assert(isfi(<span class="var type1" id="S93T7U1329">max_voltage</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,701" id="srcline701">701</a></span><span class="line">        assert(isfi(<span class="var type1" id="S94T7U1335">pos_deviance_threshold</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,702" id="srcline702">702</a></span><span class="line">        assert(isfi(<span class="var type1" id="S95T7U1341">neg_deviance_threshold</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,703" id="srcline703">703</a></span><span class="line">        <span class="comment">% asserts that input parameters are of specific fixed point parameters</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,704" id="srcline704">704</a></span><span class="line">        assert(<span class="mxinfo" id="T6:U24">isequal(numerictype(<span class="var type1" id="S91T71U1350">R_peak_vals</span>), <span class="var type1" id="S96T8U1351">Fixed_Point_Properties</span>) &amp;&amp; isequal(fimath(<span class="var type1" id="S91T71U1356">R_peak_vals</span>), <span class="var type1" id="S99T9U1357">F</span>)</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,705" id="srcline705">705</a></span><span class="line">        assert(<span class="mxinfo" id="T6:U29">isequal(numerictype(<span class="var type1" id="S92T7U1366">threshold</span>), <span class="var type1" id="S96T8U1367">Fixed_Point_Properties</span>) &amp;&amp; isequal(fimath(<span class="var type1" id="S92T7U1372">threshold</span>), <span class="var type1" id="S99T9U1373">F</span>)</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,706" id="srcline706">706</a></span><span class="line">        assert(<span class="mxinfo" id="T6:U34">isequal(numerictype(<span class="var type1" id="S93T7U1382">max_voltage</span>), <span class="var type1" id="S96T8U1383">Fixed_Point_Properties</span>) &amp;&amp; isequal(fimath(<span class="var type1" id="S93T7U1388">max_voltage</span>), <span class="var type1" id="S99T9U1389">F</span>)</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,707" id="srcline707">707</a></span><span class="line">        assert(<span class="mxinfo" id="T6:U39">isequal(numerictype(<span class="var type1" id="S94T7U1398">pos_deviance_threshold</span>), <span class="var type1" id="S96T8U1399">Fixed_Point_Properties</span>) &amp;&amp; isequal(fimath(<span class="var type1" id="S94T7U1404">pos_deviance_threshold</span>), <span class="var type1" id="S99T9U1405">F</span>)</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,708" id="srcline708">708</a></span><span class="line">        assert(<span class="mxinfo" id="T6:U44">isequal(numerictype(<span class="var type1" id="S95T7U1414">neg_deviance_threshold</span>), <span class="var type1" id="S96T8U1415">Fixed_Point_Properties</span>) &amp;&amp; isequal(fimath(<span class="var type1" id="S95T7U1420">neg_deviance_threshold</span>), <span class="var type1" id="S99T9U1421">F</span>)</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,709" id="srcline709">709</a></span><span class="line">        <span class="mxinfo" id="T7:U49"><span class="var type1" id="S105T7U1424">noise_sum</span> = <span class="mxinfo" id="T7:U51">fi(0, <span class="var type1" id="S96T8U1428">Fixed_Point_Properties</span>, <span class="var type1" id="S99T9U1429">F</span>)</span></span>; <span class="mxinfo" id="T7:U54"><span class="var type1" id="S107T7U1432">signal_sum</span> = <span class="mxinfo" id="T7:U56">fi(0, <span class="var type1" id="S96T8U1436">Fixed_Point_Properties</span>, <span class="var type1" id="S99T9U1437">F</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,710" id="srcline710">710</a></span><span class="line">        <span class="mxinfo" id="T7:U59"><span class="var type1" id="S108T7U1440">noise_count</span> = <span class="mxinfo" id="T7:U61">fi(0, <span class="var type1" id="S96T8U1444">Fixed_Point_Properties</span>, <span class="var type1" id="S99T9U1445">F</span>)</span></span>; <span class="mxinfo" id="T7:U64"><span class="var type1" id="S109T7U1448">signal_count</span> = <span class="mxinfo" id="T7:U66">fi(0, <span class="var type1" id="S96T8U1452">Fixed_Point_Properties</span>, <span class="var type1" id="S99T9U1453">F</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,711" id="srcline711">711</a></span><span class="line">        <span class="mxinfo" id="T7:U69"><span class="var type1" id="S89T7U1456">noise_lvl</span> = <span class="mxinfo" id="T7:U71">fi(0, <span class="var type1" id="S96T8U1460">Fixed_Point_Properties</span>, <span class="var type1" id="S99T9U1461">F</span>)</span></span>; <span class="mxinfo" id="T7:U74"><span class="var type1" id="S90T7U1464">signal_lvl</span> = <span class="mxinfo" id="T7:U76">fi(0,<span class="var type1" id="S96T8U1468">Fixed_Point_Properties</span>, <span class="var type1" id="S99T9U1469">F</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,712" id="srcline712">712</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,713" id="srcline713">713</a></span><span class="line">        <span class="keyword">for</span> <span class="var type1" id="S110T2U1472">index</span>=<span class="mxinfo" id="T2:U80">1</span>:<span class="mxinfo" id="T2:U81">length(<span class="var type1" id="S91T71U1477">R_peak_vals</span>)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,714" id="srcline714">714</a></span><span class="line">               <span class="comment">% DELETE AFTER DEBUGGING</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,715" id="srcline715">715</a></span><span class="line">               <span class="comment">%if (shouldPlot &amp;&amp; channel == 2)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,716" id="srcline716">716</a></span><span class="line">               <span class="comment">%    fprintf('The peak val is: %f\n',R_peak_vals(index));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,717" id="srcline717">717</a></span><span class="line">               <span class="comment">%end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,718" id="srcline718">718</a></span><span class="line">           <span class="keyword">if</span> (<span class="mxinfo" id="T6:U83"><span class="mxinfo" id="T30:U84"><span class="mxinfo" id="T7:U85"><span class="var type1" id="S91T71U1484">R_peak_vals</span>(<span class="var type1" id="S110T2U1485">index</span>)</span> * <span class="var type1" id="S93T7U1486">max_voltage</span></span> &gt; <span class="var type1" id="S92T7U1487">threshold</span></span>) </span></span>
<span class="srcline"><span class="lineno"><a href="1,719" id="srcline719">719</a></span><span class="line">               <span class="comment">%fprintf('mv: %f. Threshold is: %f\n', R_peak_vals(index) * max_voltage, threshold);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,720" id="srcline720">720</a></span><span class="line">               <span class="comment">%R_peak_vals(index)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,721" id="srcline721">721</a></span><span class="line">               </span></span>
<span class="srcline"><span class="lineno"><a href="1,722" id="srcline722">722</a></span><span class="line">               <span class="comment">% Filters out any signal value which exceeds the allowed deviance from</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,723" id="srcline723">723</a></span><span class="line">               <span class="comment">% the average signal value </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,724" id="srcline724">724</a></span><span class="line">               <span class="keyword">if</span> (<span class="mxinfo" id="T6:U90">~<span class="mxinfo" id="T6:U91"><span class="fcn" id="F280N4:B1493">meets_deviance_threshold</span>(<span class="mxinfo" id="T7:U92"><span class="var type1" id="S91T71U1495">R_peak_vals</span>(<span class="var type1" id="S110T2U1496">index</span>)</span>, <span class="var type1" id="S90T7U1497">signal_lvl</span>, <span class="var type1" id="S94T7U1498">pos_deviance_threshold</span>, <span class="var type1" id="S95T7U1499">neg_deviance_threshold</span>)</span></span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,725" id="srcline725">725</a></span><span class="line"><span class="comment">%                   fprintf('%f, %f Does not meet the deviance threshold\n', R_peak_vals(index), signal_lvl);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,726" id="srcline726">726</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,727" id="srcline727">727</a></span><span class="line">                   <span class="comment">% Sets all the indices which R_vals don't meet the threshold to 0</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,728" id="srcline728">728</a></span><span class="line">                   <span class="mxinfo" id="T3:U98"><span class="mxinfo" id="T3:U99"><span class="var type1" id="S88T73U1503">indices</span>(<span class="var type1" id="S110T2U1504">index</span>)</span> = <span class="mxinfo" id="T2:U102">0</span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="1,729" id="srcline729">729</a></span><span class="line">                   </span></span>
<span class="srcline"><span class="lineno"><a href="1,730" id="srcline730">730</a></span><span class="line">                   <span class="comment">% Updates the average noise signal lvl</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,731" id="srcline731">731</a></span><span class="line">                   <span class="mxinfo" id="T7:U103"><span class="var type1" id="S105T7U1508">noise_sum</span> = <span class="mxinfo" id="T7:U105"><span class="var type1" id="S105T7U1510">noise_sum</span>  + <span class="mxinfo" id="T7:U107"><span class="var type1" id="S91T71U1512">R_peak_vals</span>(<span class="var type1" id="S110T2U1513">index</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,732" id="srcline732">732</a></span><span class="line">                   <span class="mxinfo" id="T7:U110"><span class="var type1" id="S108T7U1516">noise_count</span> = <span class="mxinfo" id="T7:U112"><span class="var type1" id="S108T7U1518">noise_count</span> + 1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,733" id="srcline733">733</a></span><span class="line">                   </span></span>
<span class="srcline"><span class="lineno"><a href="1,734" id="srcline734">734</a></span><span class="line">                   <span class="comment">% Calculates the noise level</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,735" id="srcline735">735</a></span><span class="line"><span class="comment">%                    noise_lvl = noise_sum / noise_count;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,736" id="srcline736">736</a></span><span class="line">                   <span class="mxinfo" id="T7:U114"><span class="var type1" id="S89T7U1522">noise_lvl</span> = <span class="mxinfo" id="T7:U116">divide(<span class="var type1" id="S96T8U1525">Fixed_Point_Properties</span>, <span class="var type1" id="S105T7U1526">noise_sum</span>, <span class="var type1" id="S108T7U1527">noise_count</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,737" id="srcline737">737</a></span><span class="line">                   <span class="keyword">continue</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,738" id="srcline738">738</a></span><span class="line">               <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,739" id="srcline739">739</a></span><span class="line">               <span class="comment">% DELETE AFTER DEBUGGING</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,740" id="srcline740">740</a></span><span class="line">               <span class="comment">%if (shouldPlot &amp;&amp; channel == 2)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,741" id="srcline741">741</a></span><span class="line">               <span class="comment">%   fprintf('The peak val is: %f\n',R_peak_vals(index));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,742" id="srcline742">742</a></span><span class="line">               <span class="comment">%end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,743" id="srcline743">743</a></span><span class="line">               </span></span>
<span class="srcline"><span class="lineno"><a href="1,744" id="srcline744">744</a></span><span class="line">                <span class="comment">% Updates the average signal lvl</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,745" id="srcline745">745</a></span><span class="line">               <span class="mxinfo" id="T7:U120"><span class="var type1" id="S107T7U1531">signal_sum</span> = <span class="mxinfo" id="T7:U122"><span class="var type1" id="S107T7U1533">signal_sum</span> + <span class="mxinfo" id="T7:U124"><span class="var type1" id="S91T71U1535">R_peak_vals</span>(<span class="var type1" id="S110T2U1536">index</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,746" id="srcline746">746</a></span><span class="line">               <span class="mxinfo" id="T7:U127"><span class="var type1" id="S109T7U1539">signal_count</span> = <span class="mxinfo" id="T7:U129"><span class="var type1" id="S109T7U1541">signal_count</span> + 1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,747" id="srcline747">747</a></span><span class="line">               </span></span>
<span class="srcline"><span class="lineno"><a href="1,748" id="srcline748">748</a></span><span class="line">               <span class="comment">% Calculates the signal level</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,749" id="srcline749">749</a></span><span class="line">               <span class="mxinfo" id="T7:U131"><span class="var type1" id="S90T7U1545">signal_lvl</span> = <span class="mxinfo" id="T7:U133">divide(<span class="var type1" id="S96T8U1548">Fixed_Point_Properties</span>, <span class="var type1" id="S107T7U1549">signal_sum</span>, <span class="var type1" id="S107T7U1550">signal_sum</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,750" id="srcline750">750</a></span><span class="line">           <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,751" id="srcline751">751</a></span><span class="line">               <span class="comment">% Sets all the indices which R_vals don't meet the threshold to 0</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,752" id="srcline752">752</a></span><span class="line">               <span class="mxinfo" id="T3:U137"><span class="mxinfo" id="T3:U138"><span class="var type1" id="S88T73U1555">indices</span>(<span class="var type1" id="S110T2U1556">index</span>)</span> = <span class="mxinfo" id="T2:U141">0</span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="1,753" id="srcline753">753</a></span><span class="line">               <span class="comment">% Updates the average noise signal lvl</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,754" id="srcline754">754</a></span><span class="line">               <span class="mxinfo" id="T7:U142"><span class="var type1" id="S105T7U1560">noise_sum</span> = <span class="mxinfo" id="T7:U144"><span class="var type1" id="S105T7U1562">noise_sum</span>  + <span class="mxinfo" id="T7:U146"><span class="var type1" id="S91T71U1564">R_peak_vals</span>(<span class="var type1" id="S110T2U1565">index</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,755" id="srcline755">755</a></span><span class="line">               <span class="mxinfo" id="T7:U149"><span class="var type1" id="S108T7U1568">noise_count</span> = <span class="mxinfo" id="T7:U151"><span class="var type1" id="S108T7U1570">noise_count</span> + 1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,756" id="srcline756">756</a></span><span class="line">               <span class="comment">% Calculates the noise level</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,757" id="srcline757">757</a></span><span class="line"><span class="comment">%                noise_lvl = noise_sum / noise_count;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,758" id="srcline758">758</a></span><span class="line">               <span class="mxinfo" id="T7:U153"><span class="var type1" id="S89T7U1574">noise_lvl</span> = <span class="mxinfo" id="T7:U155">divide(<span class="var type1" id="S96T8U1577">Fixed_Point_Properties</span>, <span class="var type1" id="S105T7U1578">noise_sum</span>, <span class="var type1" id="S108T7U1579">noise_count</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,759" id="srcline759">759</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,760" id="srcline760">760</a></span><span class="line">           <span class="keyword">end</span>          </span></span>
<span class="srcline"><span class="lineno"><a href="1,761" id="srcline761">761</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,762" id="srcline762">762</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,763" id="srcline763">763</a></span><span class="line">    </span></span>
</pre>
