<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,659" id="srcline659">659</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,660" id="srcline660">660</a></span><span class="line"><span class="comment">%DUAL THRESHOLD PROCESSSING</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,661" id="srcline661">661</a></span><span class="line"><span class="comment">% Filters out R_peaks which don't meet the threshold reqs</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,662" id="srcline662">662</a></span><span class="line">    <span class="keyword">function</span> [<span class="var type1" id="S89T61U1276">indices</span>, <span class="var type1" id="S90T7U1277">noise_lvl</span>, <span class="var type1" id="S91T7U1278">signal_lvl</span>] = dualThreshold(<span class="var type1" id="S92T59U1281">R_peak_vals</span>, <span class="var type1" id="S93T7U1282">threshold</span>, <span class="mxinfo" id="T61:U6"><span class="mxinfo" id="T61:U7"><span class="var type1" id="S89T61U1283">indices</span></span></span>, <span class="var type1" id="S94T43U1284">max_voltage</span>, <span class="var type1" id="S95T7U1285">pos_deviance_threshold</span>, <span class="var type1" id="S96T7U1286">neg_deviance_threshold</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,663" id="srcline663">663</a></span><span class="line">        <span class="mxinfo" id="T8:U12"><span class="var type1" id="S97T8U1289">Fixed_Point_Properties</span> = <span class="mxinfo" id="T8:U14">numerictype(<span class="string">'WordLength'</span>, 32, <span class="string">'FractionLength'</span>, 12, <span class="string">'Signed'</span>,false)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,664" id="srcline664">664</a></span><span class="line">        <span class="mxinfo" id="T9:U15"><span class="var type1" id="S100T9U1301">F</span> = <span class="mxinfo" id="T9:U17">fimath(<span class="string">'OverflowMode'</span>,<span class="string">'saturate'</span>, <span class="string">'RoundMode'</span>, <span class="string">'nearest'</span>, <span class="string">'ProductFractionLength'</span>, 20,<span class="string">'ProductMode'</span>, <span class="string">'SpecifyPrecision'</span>, <span class="string">'MaxProductWordLength'</span>, 32, <span class="string">'SumFractionLength'</span>, 12, <span class="string">'SumMode'</span>, <span class="string">'SpecifyPrecision'</span>,<span class="string">'MaxSumWordLength'</span>, 32)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,665" id="srcline665">665</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,666" id="srcline666">666</a></span><span class="line">        <span class="comment">% asserts that the input parameters are of fixed point</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,667" id="srcline667">667</a></span><span class="line">        assert(isfi(<span class="var type1" id="S92T59U1325">R_peak_vals</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,668" id="srcline668">668</a></span><span class="line">        assert(isfi(<span class="var type1" id="S93T7U1331">threshold</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,669" id="srcline669">669</a></span><span class="line">        assert(isa(<span class="var type1" id="S89T61U1337">indices</span>,<span class="string">'uint32'</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,670" id="srcline670">670</a></span><span class="line">        assert(isfi(<span class="var type1" id="S94T43U1344">max_voltage</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,671" id="srcline671">671</a></span><span class="line">        assert(isfi(<span class="var type1" id="S95T7U1350">pos_deviance_threshold</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,672" id="srcline672">672</a></span><span class="line">        assert(isfi(<span class="var type1" id="S96T7U1356">neg_deviance_threshold</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,673" id="srcline673">673</a></span><span class="line">        <span class="comment">% asserts that input parameters are of specific fixed point parameters</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,674" id="srcline674">674</a></span><span class="line">        <span class="mxinfo" id="T11:U24">assert(<span class="mxinfo" id="T6:U25">isequal(numerictype(<span class="var type1" id="S92T59U1365">R_peak_vals</span>), <span class="var type1" id="S97T8U1366">Fixed_Point_Properties</span>) &amp;&amp; isequal(fimath(<span class="var type2" id="S92T0U1371">R_peak_vals</span>), <span class="var type2" id="S100T0U1372">F</span>)</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,675" id="srcline675">675</a></span><span class="line">        assert(<span class="mxinfo" id="T6:U28">isequal(numerictype(<span class="var type1" id="S93T7U1381">threshold</span>), <span class="var type1" id="S97T8U1382">Fixed_Point_Properties</span>) &amp;&amp; isequal(fimath(<span class="var type1" id="S93T7U1387">threshold</span>), <span class="var type1" id="S100T9U1388">F</span>)</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,676" id="srcline676">676</a></span><span class="line">        <span class="mxinfo" id="T11:U33">assert(<span class="mxinfo" id="T6:U34">isequal(numerictype(<span class="var type1" id="S94T43U1397">max_voltage</span>), <span class="var type1" id="S97T8U1398">Fixed_Point_Properties</span>) &amp;&amp; isequal(fimath(<span class="var type2" id="S94T0U1403">max_voltage</span>), <span class="var type2" id="S100T0U1404">F</span>)</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,677" id="srcline677">677</a></span><span class="line">        assert(<span class="mxinfo" id="T6:U37">isequal(numerictype(<span class="var type1" id="S95T7U1413">pos_deviance_threshold</span>), <span class="var type1" id="S97T8U1414">Fixed_Point_Properties</span>) &amp;&amp; isequal(fimath(<span class="var type1" id="S95T7U1419">pos_deviance_threshold</span>), <span class="var type1" id="S100T9U1420">F</span>)</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,678" id="srcline678">678</a></span><span class="line">        assert(<span class="mxinfo" id="T6:U42">isequal(numerictype(<span class="var type1" id="S96T7U1429">neg_deviance_threshold</span>), <span class="var type1" id="S97T8U1430">Fixed_Point_Properties</span>) &amp;&amp; isequal(fimath(<span class="var type1" id="S96T7U1435">neg_deviance_threshold</span>), <span class="var type1" id="S100T9U1436">F</span>)</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,679" id="srcline679">679</a></span><span class="line">        <span class="mxinfo" id="T7:U47"><span class="var type1" id="S106T7U1439">noise_sum</span> = <span class="mxinfo" id="T7:U49">fi(0, <span class="var type1" id="S97T8U1443">Fixed_Point_Properties</span>, <span class="var type1" id="S100T9U1444">F</span>)</span></span>; <span class="mxinfo" id="T7:U52"><span class="var type1" id="S108T7U1447">signal_sum</span> = <span class="mxinfo" id="T7:U54">fi(0, <span class="var type1" id="S97T8U1451">Fixed_Point_Properties</span>, <span class="var type1" id="S100T9U1452">F</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,680" id="srcline680">680</a></span><span class="line">        <span class="mxinfo" id="T7:U57"><span class="var type1" id="S109T7U1455">noise_count</span> = <span class="mxinfo" id="T7:U59">fi(0, <span class="var type1" id="S97T8U1459">Fixed_Point_Properties</span>, <span class="var type1" id="S100T9U1460">F</span>)</span></span>; <span class="mxinfo" id="T7:U62"><span class="var type1" id="S110T7U1463">signal_count</span> = <span class="mxinfo" id="T7:U64">fi(0, <span class="var type1" id="S97T8U1467">Fixed_Point_Properties</span>, <span class="var type1" id="S100T9U1468">F</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,681" id="srcline681">681</a></span><span class="line">        <span class="mxinfo" id="T7:U67"><span class="var type1" id="S90T7U1471">noise_lvl</span> = <span class="mxinfo" id="T7:U69">fi(0, <span class="var type1" id="S97T8U1475">Fixed_Point_Properties</span>, <span class="var type1" id="S100T9U1476">F</span>)</span></span>; <span class="mxinfo" id="T7:U72"><span class="var type1" id="S91T7U1479">signal_lvl</span> = <span class="mxinfo" id="T7:U74">fi(0,<span class="var type1" id="S97T8U1483">Fixed_Point_Properties</span>, <span class="var type1" id="S100T9U1484">F</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,682" id="srcline682">682</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,683" id="srcline683">683</a></span><span class="line">        <span class="keyword">for</span> <span class="var type1" id="S111T2U1487">index</span>=<span class="mxinfo" id="T66:U78"><span class="mxinfo" id="T2:U79">1</span>:<span class="mxinfo" id="T2:U80">length(<span class="var type1" id="S92T59U1492">R_peak_vals</span>)</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,684" id="srcline684">684</a></span><span class="line">               <span class="comment">% DELETE AFTER DEBUGGING</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,685" id="srcline685">685</a></span><span class="line">               <span class="comment">%if (shouldPlot &amp;&amp; channel == 2)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,686" id="srcline686">686</a></span><span class="line">               <span class="comment">%    fprintf('The peak val is: %f\n',R_peak_vals(index));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,687" id="srcline687">687</a></span><span class="line">               <span class="comment">%end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,688" id="srcline688">688</a></span><span class="line">           <span class="keyword">if</span> (<span class="mxinfo" id="T6:U82"><span class="mxinfo" id="T43:U83"><span class="mxinfo" id="T43:U84"><span class="var type1" id="S92T59U1499">R_peak_vals</span>(<span class="var type1" id="S111T2U1500">index</span>)</span> * <span class="var type1" id="S94T43U1501">max_voltage</span></span> &gt; <span class="var type1" id="S93T7U1502">threshold</span></span>) </span></span>
<span class="srcline"><span class="lineno"><a href="1,689" id="srcline689">689</a></span><span class="line">               <span class="comment">%fprintf('mv: %f. Threshold is: %f\n', R_peak_vals(index) * max_voltage, threshold);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,690" id="srcline690">690</a></span><span class="line">               <span class="comment">%R_peak_vals(index)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,691" id="srcline691">691</a></span><span class="line">               <span class="comment">% Filters out any signal value which exceeds the allowed deviance from</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,692" id="srcline692">692</a></span><span class="line">               <span class="comment">% the average signal value </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,693" id="srcline693">693</a></span><span class="line">               <span class="keyword">if</span> (<span class="mxinfo" id="T86:U89">~<span class="message error" id="M6F283C"><span class="mxinfo" id="T87:U90"><span class="fcn" id="F296N4:B1508">meets_deviance_threshold</span></span>(<span class="mxinfo" id="T43:U91"><span class="var type1" id="S92T59U1510">R_peak_vals</span>(<span class="var type1" id="S111T2U1511">index</span>)</span>, <span class="var type1" id="S91T7U1512">signal_lvl</span>, <span class="var type1" id="S95T7U1513">pos_deviance_threshold</span>, <span class="var type1" id="S96T7U1514">neg_deviance_threshold</span>)</span></span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,694" id="srcline694">694</a></span><span class="line"><span class="comment">%                   fprintf('%f, %f Does not meet the deviance threshold\n', R_peak_vals(index), signal_lvl);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,695" id="srcline695">695</a></span><span class="line">                   <span class="comment">% Sets all the indices which R_vals don't meet the threshold to 0</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,696" id="srcline696">696</a></span><span class="line">                   <span class="mxinfo" id="T3:U97"><span class="mxinfo" id="T3:U98"><span class="var type1" id="S89T61U1518">indices</span>(<span class="var type1" id="S111T2U1519">index</span>)</span> = <span class="mxinfo" id="T2:U101">0</span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="1,697" id="srcline697">697</a></span><span class="line">                   <span class="comment">% Updates the average noise signal lvl</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,698" id="srcline698">698</a></span><span class="line">                   <span class="var type2" id="S106T0U1523">noise_sum</span> = <span class="mxinfo" id="T88:U102"><span class="message error" id="M7F283C"><span class="message error" id="M8F283C"><span class="var type1" id="S106T7U1525">noise_sum</span>  + <span class="mxinfo" id="T43:U104"><span class="var type1" id="S92T59U1527">R_peak_vals</span>(<span class="var type1" id="S111T2U1528">index</span>)</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,699" id="srcline699">699</a></span><span class="line">                   <span class="mxinfo" id="T7:U107"><span class="var type1" id="S109T7U1531">noise_count</span> = <span class="mxinfo" id="T7:U109"><span class="var type1" id="S109T7U1533">noise_count</span> + 1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,700" id="srcline700">700</a></span><span class="line">                   <span class="comment">% Calculates the noise level</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,701" id="srcline701">701</a></span><span class="line"><span class="comment">%                    noise_lvl = noise_sum / noise_count;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,702" id="srcline702">702</a></span><span class="line">                   <span class="mxinfo" id="T7:U111"><span class="var type1" id="S90T7U1537">noise_lvl</span> = <span class="mxinfo" id="T7:U113">divide(<span class="var type1" id="S97T8U1540">Fixed_Point_Properties</span>, <span class="var type1" id="S106T7U1541">noise_sum</span>, <span class="var type1" id="S109T7U1542">noise_count</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,703" id="srcline703">703</a></span><span class="line">                   <span class="keyword">continue</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,704" id="srcline704">704</a></span><span class="line">               <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,705" id="srcline705">705</a></span><span class="line">               <span class="comment">% DELETE AFTER DEBUGGING</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,706" id="srcline706">706</a></span><span class="line">               <span class="comment">%if (shouldPlot &amp;&amp; channel == 2)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,707" id="srcline707">707</a></span><span class="line">               <span class="comment">%   fprintf('The peak val is: %f\n',R_peak_vals(index));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,708" id="srcline708">708</a></span><span class="line">               <span class="comment">%end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,709" id="srcline709">709</a></span><span class="line">                <span class="comment">% Updates the average signal lvl</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,710" id="srcline710">710</a></span><span class="line">               <span class="var type2" id="S108T0U1546">signal_sum</span> = <span class="mxinfo" id="T89:U117"><span class="message error" id="M9F283C"><span class="message error" id="M10F283C"><span class="var type1" id="S108T7U1548">signal_sum</span> + <span class="mxinfo" id="T43:U119"><span class="var type1" id="S92T59U1550">R_peak_vals</span>(<span class="var type1" id="S111T2U1551">index</span>)</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,711" id="srcline711">711</a></span><span class="line">               <span class="mxinfo" id="T7:U122"><span class="var type1" id="S110T7U1554">signal_count</span> = <span class="mxinfo" id="T7:U124"><span class="var type1" id="S110T7U1556">signal_count</span> + 1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,712" id="srcline712">712</a></span><span class="line">               <span class="comment">% Calculates the signal level</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,713" id="srcline713">713</a></span><span class="line"><span class="comment">%                signal_lvl = signal_sum / signal_count;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,714" id="srcline714">714</a></span><span class="line">               <span class="mxinfo" id="T7:U126"><span class="var type1" id="S91T7U1560">signal_lvl</span> = <span class="mxinfo" id="T7:U128">divide(<span class="var type1" id="S97T8U1563">Fixed_Point_Properties</span>, <span class="var type1" id="S108T7U1564">signal_sum</span>, <span class="var type1" id="S108T7U1565">signal_sum</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,715" id="srcline715">715</a></span><span class="line">           <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,716" id="srcline716">716</a></span><span class="line">               <span class="comment">% Sets all the indices which R_vals don't meet the threshold to 0</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,717" id="srcline717">717</a></span><span class="line">               <span class="mxinfo" id="T3:U132"><span class="mxinfo" id="T3:U133"><span class="var type1" id="S89T61U1570">indices</span>(<span class="var type1" id="S111T2U1571">index</span>)</span> = <span class="mxinfo" id="T2:U136">0</span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="1,718" id="srcline718">718</a></span><span class="line">               <span class="comment">% Updates the average noise signal lvl</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,719" id="srcline719">719</a></span><span class="line">               <span class="var type2" id="S106T0U1575">noise_sum</span> = <span class="mxinfo" id="T90:U137"><span class="message error" id="M11F283C"><span class="message error" id="M12F283C"><span class="var type1" id="S106T7U1577">noise_sum</span>  + <span class="mxinfo" id="T43:U139"><span class="var type1" id="S92T59U1579">R_peak_vals</span>(<span class="var type1" id="S111T2U1580">index</span>)</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,720" id="srcline720">720</a></span><span class="line">               <span class="mxinfo" id="T7:U142"><span class="var type1" id="S109T7U1583">noise_count</span> = <span class="mxinfo" id="T7:U144"><span class="var type1" id="S109T7U1585">noise_count</span> + 1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,721" id="srcline721">721</a></span><span class="line">               <span class="comment">% Calculates the noise level</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,722" id="srcline722">722</a></span><span class="line"><span class="comment">%                noise_lvl = noise_sum / noise_count;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,723" id="srcline723">723</a></span><span class="line">               <span class="mxinfo" id="T7:U146"><span class="var type1" id="S90T7U1589">noise_lvl</span> = <span class="mxinfo" id="T7:U148">divide(<span class="var type1" id="S97T8U1592">Fixed_Point_Properties</span>, <span class="var type1" id="S106T7U1593">noise_sum</span>, <span class="var type1" id="S109T7U1594">noise_count</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,724" id="srcline724">724</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,725" id="srcline725">725</a></span><span class="line">           <span class="keyword">end</span>          </span></span>
<span class="srcline"><span class="lineno"><a href="1,726" id="srcline726">726</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,727" id="srcline727">727</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,728" id="srcline728">728</a></span><span class="line">    </span></span>
</pre>
