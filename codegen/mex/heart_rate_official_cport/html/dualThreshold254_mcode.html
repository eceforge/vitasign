<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,640" id="srcline640">640</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,641" id="srcline641">641</a></span><span class="line"><span class="comment">%DUAL THRESHOLD PROCESSSING</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,642" id="srcline642">642</a></span><span class="line"><span class="comment">% Filters out R_peaks which don't meet the threshold reqs</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,643" id="srcline643">643</a></span><span class="line">    <span class="keyword">function</span> [<span class="var type1" id="S87T63U1139">indices</span>, <span class="var type1" id="S88T4U1140">noise_lvl</span>, <span class="var type1" id="S89T4U1141">signal_lvl</span>] = dualThreshold(<span class="var type1" id="S90T61U1144">R_peak_vals</span>, <span class="var type1" id="S91T4U1145">threshold</span>, <span class="mxinfo" id="T63:U6"><span class="mxinfo" id="T63:U7"><span class="var type1" id="S87T63U1146">indices</span></span></span>, <span class="var type1" id="S92T4U1147">max_voltage</span>, <span class="var type1" id="S93T4U1148">pos_deviance_threshold</span>, <span class="var type1" id="S94T4U1149">neg_deviance_threshold</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,644" id="srcline644">644</a></span><span class="line">        <span class="mxinfo" id="T5:U12"><span class="var type1" id="S95T5U1152">Fixed_Point_Properties</span> = <span class="mxinfo" id="T5:U14">numerictype(<span class="string">'WordLength'</span>, 32, <span class="string">'FractionLength'</span>, 16, <span class="string">'Signed'</span>,false)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,645" id="srcline645">645</a></span><span class="line">        <span class="mxinfo" id="T7:U15"><span class="var type1" id="S98T7U1164">F</span> = <span class="mxinfo" id="T7:U17">fimath(<span class="string">'OverflowMode'</span>,<span class="string">'saturate'</span>, <span class="string">'RoundMode'</span>, <span class="string">'nearest'</span>, <span class="string">'ProductFractionLength'</span>, 16,<span class="string">'ProductMode'</span>, <span class="string">'SpecifyPrecision'</span>, <span class="string">'MaxProductWordLength'</span>, 32, <span class="string">'SumFractionLength'</span>, 16, <span class="string">'SumMode'</span>, <span class="string">'SpecifyPrecision'</span>,<span class="string">'MaxSumWordLength'</span>, 32)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,646" id="srcline646">646</a></span><span class="line">        <span class="comment">% asserts that the input parameters are of fixed point</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,647" id="srcline647">647</a></span><span class="line">        assert(isfi(<span class="var type1" id="S90T61U1188">R_peak_vals</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,648" id="srcline648">648</a></span><span class="line">        assert(isfi(<span class="var type1" id="S91T4U1194">threshold</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,649" id="srcline649">649</a></span><span class="line">        assert(isa(<span class="var type1" id="S87T63U1200">indices</span>,<span class="string">'uint32'</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,650" id="srcline650">650</a></span><span class="line">        assert(isfi(<span class="var type1" id="S92T4U1207">max_voltage</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,651" id="srcline651">651</a></span><span class="line">        assert(isfi(<span class="var type1" id="S93T4U1213">pos_deviance_threshold</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,652" id="srcline652">652</a></span><span class="line">        assert(isfi(<span class="var type1" id="S94T4U1219">neg_deviance_threshold</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,653" id="srcline653">653</a></span><span class="line">        <span class="comment">% asserts that input parameters are of specific fixed point parameters</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,654" id="srcline654">654</a></span><span class="line">        assert(<span class="mxinfo" id="T6:U24">isequal(numerictype(<span class="var type1" id="S90T61U1228">R_peak_vals</span>), <span class="var type1" id="S95T5U1229">Fixed_Point_Properties</span>) &amp;&amp; isequal(fimath(<span class="var type1" id="S90T61U1234">R_peak_vals</span>), <span class="var type1" id="S98T7U1235">F</span>)</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,655" id="srcline655">655</a></span><span class="line">        assert(<span class="mxinfo" id="T6:U29">isequal(numerictype(<span class="var type1" id="S91T4U1244">threshold</span>), <span class="var type1" id="S95T5U1245">Fixed_Point_Properties</span>) &amp;&amp; isequal(fimath(<span class="var type1" id="S91T4U1250">threshold</span>), <span class="var type1" id="S98T7U1251">F</span>)</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,656" id="srcline656">656</a></span><span class="line">        assert(<span class="mxinfo" id="T6:U34">isequal(numerictype(<span class="var type1" id="S92T4U1260">max_voltage</span>), <span class="var type1" id="S95T5U1261">Fixed_Point_Properties</span>) &amp;&amp; isequal(fimath(<span class="var type1" id="S92T4U1266">max_voltage</span>), <span class="var type1" id="S98T7U1267">F</span>)</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,657" id="srcline657">657</a></span><span class="line">        assert(<span class="mxinfo" id="T6:U39">isequal(numerictype(<span class="var type1" id="S93T4U1276">pos_deviance_threshold</span>), <span class="var type1" id="S95T5U1277">Fixed_Point_Properties</span>) &amp;&amp; isequal(fimath(<span class="var type1" id="S93T4U1282">pos_deviance_threshold</span>), <span class="var type1" id="S98T7U1283">F</span>)</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,658" id="srcline658">658</a></span><span class="line">        assert(<span class="mxinfo" id="T6:U44">isequal(numerictype(<span class="var type1" id="S94T4U1292">neg_deviance_threshold</span>), <span class="var type1" id="S95T5U1293">Fixed_Point_Properties</span>) &amp;&amp; isequal(fimath(<span class="var type1" id="S94T4U1298">neg_deviance_threshold</span>), <span class="var type1" id="S98T7U1299">F</span>)</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,659" id="srcline659">659</a></span><span class="line">        <span class="mxinfo" id="T4:U49"><span class="var type1" id="S104T4U1302">noise_sum</span> = <span class="mxinfo" id="T4:U51">fi(0, <span class="var type1" id="S95T5U1306">Fixed_Point_Properties</span>, <span class="var type1" id="S98T7U1307">F</span>)</span></span>; <span class="mxinfo" id="T4:U54"><span class="var type1" id="S106T4U1310">signal_sum</span> = <span class="mxinfo" id="T4:U56">fi(0, <span class="var type1" id="S95T5U1314">Fixed_Point_Properties</span>, <span class="var type1" id="S98T7U1315">F</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,660" id="srcline660">660</a></span><span class="line">        <span class="mxinfo" id="T4:U59"><span class="var type1" id="S107T4U1318">noise_count</span> = <span class="mxinfo" id="T4:U61">fi(0, <span class="var type1" id="S95T5U1322">Fixed_Point_Properties</span>, <span class="var type1" id="S98T7U1323">F</span>)</span></span>; <span class="mxinfo" id="T4:U64"><span class="var type1" id="S108T4U1326">signal_count</span> = <span class="mxinfo" id="T4:U66">fi(0, <span class="var type1" id="S95T5U1330">Fixed_Point_Properties</span>, <span class="var type1" id="S98T7U1331">F</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,661" id="srcline661">661</a></span><span class="line">        <span class="mxinfo" id="T4:U69"><span class="var type1" id="S88T4U1334">noise_lvl</span> = <span class="mxinfo" id="T4:U71">fi(0, <span class="var type1" id="S95T5U1338">Fixed_Point_Properties</span>, <span class="var type1" id="S98T7U1339">F</span>)</span></span>; <span class="mxinfo" id="T4:U74"><span class="var type1" id="S89T4U1342">signal_lvl</span> = <span class="mxinfo" id="T4:U76">fi(0,<span class="var type1" id="S95T5U1346">Fixed_Point_Properties</span>, <span class="var type1" id="S98T7U1347">F</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,662" id="srcline662">662</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,663" id="srcline663">663</a></span><span class="line">        <span class="keyword">for</span> <span class="var type1" id="S109T2U1350">index</span>=<span class="mxinfo" id="T2:U80">1</span>:<span class="mxinfo" id="T2:U81">length(<span class="var type1" id="S90T61U1355">R_peak_vals</span>)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,664" id="srcline664">664</a></span><span class="line">               <span class="comment">% DELETE AFTER DEBUGGING</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,665" id="srcline665">665</a></span><span class="line">               <span class="comment">%if (shouldPlot &amp;&amp; channel == 2)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,666" id="srcline666">666</a></span><span class="line">               <span class="comment">%    fprintf('The peak val is: %f\n',R_peak_vals(index));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,667" id="srcline667">667</a></span><span class="line">               <span class="comment">%end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,668" id="srcline668">668</a></span><span class="line">           <span class="keyword">if</span> (<span class="mxinfo" id="T6:U83"><span class="mxinfo" id="T4:U84"><span class="mxinfo" id="T4:U85"><span class="var type1" id="S90T61U1362">R_peak_vals</span>(<span class="var type1" id="S109T2U1363">index</span>)</span> * <span class="var type1" id="S92T4U1364">max_voltage</span></span> &gt; <span class="var type1" id="S91T4U1365">threshold</span></span>) </span></span>
<span class="srcline"><span class="lineno"><a href="1,669" id="srcline669">669</a></span><span class="line">               <span class="comment">%fprintf('mv: %f. Threshold is: %f\n', R_peak_vals(index) * max_voltage, threshold);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,670" id="srcline670">670</a></span><span class="line">               <span class="comment">%R_peak_vals(index)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,671" id="srcline671">671</a></span><span class="line">               <span class="comment">% Filters out any signal value which exceeds the allowed deviance from</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,672" id="srcline672">672</a></span><span class="line">               <span class="comment">% the average signal value </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,673" id="srcline673">673</a></span><span class="line">               <span class="keyword">if</span> (<span class="mxinfo" id="T6:U90">~<span class="mxinfo" id="T6:U91"><span class="fcn" id="F249N4:B1371">meets_deviance_threshold</span>(<span class="mxinfo" id="T4:U92"><span class="var type1" id="S90T61U1373">R_peak_vals</span>(<span class="var type1" id="S109T2U1374">index</span>)</span>, <span class="var type1" id="S89T4U1375">signal_lvl</span>, <span class="var type1" id="S93T4U1376">pos_deviance_threshold</span>, <span class="var type1" id="S94T4U1377">neg_deviance_threshold</span>)</span></span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,674" id="srcline674">674</a></span><span class="line">                  <span class="comment">%fprintf('%f, %f Does not meet the deviance threshold\n', R_peak_vals(index), signal_lvl);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,675" id="srcline675">675</a></span><span class="line">                   <span class="comment">% Sets all the indices which R_vals don't meet the threshold to 0</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,676" id="srcline676">676</a></span><span class="line">                   <span class="mxinfo" id="T3:U98"><span class="mxinfo" id="T3:U99"><span class="var type1" id="S87T63U1381">indices</span>(<span class="var type1" id="S109T2U1382">index</span>)</span> = <span class="mxinfo" id="T2:U102">0</span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="1,677" id="srcline677">677</a></span><span class="line">                   <span class="comment">% Updates the average noise signal lvl</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,678" id="srcline678">678</a></span><span class="line">                   <span class="mxinfo" id="T4:U103"><span class="var type1" id="S104T4U1386">noise_sum</span> = <span class="mxinfo" id="T4:U105"><span class="var type1" id="S104T4U1388">noise_sum</span>  + <span class="mxinfo" id="T4:U107"><span class="var type1" id="S90T61U1390">R_peak_vals</span>(<span class="var type1" id="S109T2U1391">index</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,679" id="srcline679">679</a></span><span class="line">                   <span class="mxinfo" id="T4:U110"><span class="var type1" id="S107T4U1394">noise_count</span> = <span class="mxinfo" id="T4:U112"><span class="var type1" id="S107T4U1396">noise_count</span> + 1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,680" id="srcline680">680</a></span><span class="line">                   <span class="comment">% Calculates the noise level</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,681" id="srcline681">681</a></span><span class="line"><span class="comment">%                    noise_lvl = noise_sum / noise_count;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,682" id="srcline682">682</a></span><span class="line">                   <span class="mxinfo" id="T4:U114"><span class="var type1" id="S88T4U1400">noise_lvl</span> = <span class="mxinfo" id="T4:U116">divide(<span class="var type1" id="S95T5U1403">Fixed_Point_Properties</span>, <span class="var type1" id="S104T4U1404">noise_sum</span>, <span class="var type1" id="S107T4U1405">noise_count</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,683" id="srcline683">683</a></span><span class="line">                   <span class="keyword">continue</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,684" id="srcline684">684</a></span><span class="line">               <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,685" id="srcline685">685</a></span><span class="line">               <span class="comment">% DELETE AFTER DEBUGGING</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,686" id="srcline686">686</a></span><span class="line">               <span class="comment">%if (shouldPlot &amp;&amp; channel == 2)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,687" id="srcline687">687</a></span><span class="line">               <span class="comment">%   fprintf('The peak val is: %f\n',R_peak_vals(index));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,688" id="srcline688">688</a></span><span class="line">               <span class="comment">%end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,689" id="srcline689">689</a></span><span class="line">                <span class="comment">% Updates the average signal lvl</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,690" id="srcline690">690</a></span><span class="line">               <span class="mxinfo" id="T4:U120"><span class="var type1" id="S106T4U1409">signal_sum</span> = <span class="mxinfo" id="T4:U122"><span class="var type1" id="S106T4U1411">signal_sum</span> + <span class="mxinfo" id="T4:U124"><span class="var type1" id="S90T61U1413">R_peak_vals</span>(<span class="var type1" id="S109T2U1414">index</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,691" id="srcline691">691</a></span><span class="line">               <span class="mxinfo" id="T4:U127"><span class="var type1" id="S108T4U1417">signal_count</span> = <span class="mxinfo" id="T4:U129"><span class="var type1" id="S108T4U1419">signal_count</span> + 1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,692" id="srcline692">692</a></span><span class="line">               <span class="comment">% Calculates the signal level</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,693" id="srcline693">693</a></span><span class="line"><span class="comment">%                signal_lvl = signal_sum / signal_count;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,694" id="srcline694">694</a></span><span class="line">               <span class="mxinfo" id="T4:U131"><span class="var type1" id="S89T4U1423">signal_lvl</span> = <span class="mxinfo" id="T4:U133">divide(<span class="var type1" id="S95T5U1426">Fixed_Point_Properties</span>, <span class="var type1" id="S106T4U1427">signal_sum</span>, <span class="var type1" id="S106T4U1428">signal_sum</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,695" id="srcline695">695</a></span><span class="line">           <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,696" id="srcline696">696</a></span><span class="line">               <span class="comment">% Sets all the indices which R_vals don't meet the threshold to 0</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,697" id="srcline697">697</a></span><span class="line">               <span class="mxinfo" id="T3:U137"><span class="mxinfo" id="T3:U138"><span class="var type1" id="S87T63U1433">indices</span>(<span class="var type1" id="S109T2U1434">index</span>)</span> = <span class="mxinfo" id="T2:U141">0</span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="1,698" id="srcline698">698</a></span><span class="line">               <span class="comment">% Updates the average noise signal lvl</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,699" id="srcline699">699</a></span><span class="line">               <span class="mxinfo" id="T4:U142"><span class="var type1" id="S104T4U1438">noise_sum</span> = <span class="mxinfo" id="T4:U144"><span class="var type1" id="S104T4U1440">noise_sum</span>  + <span class="mxinfo" id="T4:U146"><span class="var type1" id="S90T61U1442">R_peak_vals</span>(<span class="var type1" id="S109T2U1443">index</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,700" id="srcline700">700</a></span><span class="line">               <span class="mxinfo" id="T4:U149"><span class="var type1" id="S107T4U1446">noise_count</span> = <span class="mxinfo" id="T4:U151"><span class="var type1" id="S107T4U1448">noise_count</span> + 1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,701" id="srcline701">701</a></span><span class="line">               <span class="comment">% Calculates the noise level</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,702" id="srcline702">702</a></span><span class="line"><span class="comment">%                noise_lvl = noise_sum / noise_count;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,703" id="srcline703">703</a></span><span class="line">               <span class="mxinfo" id="T4:U153"><span class="var type1" id="S88T4U1452">noise_lvl</span> = <span class="mxinfo" id="T4:U155">divide(<span class="var type1" id="S95T5U1455">Fixed_Point_Properties</span>, <span class="var type1" id="S104T4U1456">noise_sum</span>, <span class="var type1" id="S107T4U1457">noise_count</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,704" id="srcline704">704</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,705" id="srcline705">705</a></span><span class="line">           <span class="keyword">end</span>          </span></span>
<span class="srcline"><span class="lineno"><a href="1,706" id="srcline706">706</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,707" id="srcline707">707</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,708" id="srcline708">708</a></span><span class="line">    </span></span>
</pre>
