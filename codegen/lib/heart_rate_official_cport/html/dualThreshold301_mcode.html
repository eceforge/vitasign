<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,607" id="srcline607">607</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,608" id="srcline608">608</a></span><span class="line"><span class="comment">%DUAL THRESHOLD PROCESSSING</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,609" id="srcline609">609</a></span><span class="line"><span class="comment">% Filters out R_peaks which don't meet the threshold reqs</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,610" id="srcline610">610</a></span><span class="line">    <span class="keyword">function</span> [<span class="var type1" id="S86T65U1066">indices</span>, <span class="var type1" id="S87T4U1067">noise_lvl</span>, <span class="var type1" id="S88T4U1068">signal_lvl</span>] = dualThreshold(<span class="var type1" id="S89T64U1071">R_peak_vals</span>, <span class="var type1" id="S90T4U1072">threshold</span>, <span class="mxinfo" id="T65:U6"><span class="mxinfo" id="T65:U7"><span class="var type1" id="S86T65U1073">indices</span></span></span>, <span class="var type1" id="S91T4U1074">max_voltage</span>, <span class="var type1" id="S92T4U1075">pos_deviance_threshold</span>, <span class="var type1" id="S93T4U1076">neg_deviance_threshold</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,611" id="srcline611">611</a></span><span class="line">        <span class="mxinfo" id="T5:U12"><span class="var type1" id="S94T5U1079">Fixed_Point_Properties</span> = <span class="mxinfo" id="T5:U14">numerictype(<span class="string">'WordLength'</span>, 32, <span class="string">'FractionLength'</span>, 16, <span class="string">'Signed'</span>,false)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,612" id="srcline612">612</a></span><span class="line">        <span class="mxinfo" id="T7:U15"><span class="var type1" id="S97T7U1091">F</span> = <span class="mxinfo" id="T7:U17">fimath(<span class="string">'OverflowMode'</span>,<span class="string">'saturate'</span>, <span class="string">'RoundMode'</span>, <span class="string">'nearest'</span>, <span class="string">'ProductFractionLength'</span>, 16,<span class="string">'ProductMode'</span>, <span class="string">'SpecifyPrecision'</span>, <span class="string">'MaxProductWordLength'</span>, 32, <span class="string">'SumFractionLength'</span>, 16, <span class="string">'SumMode'</span>, <span class="string">'SpecifyPrecision'</span>,<span class="string">'MaxSumWordLength'</span>, 32)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,613" id="srcline613">613</a></span><span class="line">        <span class="comment">% Asserts that the input parameters are of fixed point</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,614" id="srcline614">614</a></span><span class="line">        assert(isfi(<span class="var type1" id="S89T64U1115">R_peak_vals</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,615" id="srcline615">615</a></span><span class="line">        assert(isfi(<span class="var type1" id="S90T4U1121">threshold</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,616" id="srcline616">616</a></span><span class="line">        <span class="mxinfo" id="T9:U20">assert(isa(<span class="var type1" id="S86T65U1127">indices</span>,<span class="string">'int32'</span>))</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,617" id="srcline617">617</a></span><span class="line">        assert(isfi(<span class="var type1" id="S91T4U1134">max_voltage</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,618" id="srcline618">618</a></span><span class="line">        assert(isfi(<span class="var type1" id="S92T4U1140">pos_deviance_threshold</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,619" id="srcline619">619</a></span><span class="line">        assert(isfi(<span class="var type1" id="S93T4U1146">neg_deviance_threshold</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,620" id="srcline620">620</a></span><span class="line">        <span class="comment">% Asserts that input parameters are of specific fixed point parameters</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,621" id="srcline621">621</a></span><span class="line">        assert(<span class="mxinfo" id="T6:U25">isequal(numerictype(<span class="var type1" id="S89T64U1155">R_peak_vals</span>), <span class="var type1" id="S94T5U1156">Fixed_Point_Properties</span>) &amp;&amp; isequal(fimath(<span class="var type1" id="S89T64U1161">R_peak_vals</span>), <span class="var type1" id="S97T7U1162">F</span>)</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,622" id="srcline622">622</a></span><span class="line">        assert(<span class="mxinfo" id="T6:U30">isequal(numerictype(<span class="var type1" id="S90T4U1171">threshold</span>), <span class="var type1" id="S94T5U1172">Fixed_Point_Properties</span>) &amp;&amp; isequal(fimath(<span class="var type1" id="S90T4U1177">threshold</span>), <span class="var type1" id="S97T7U1178">F</span>)</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,623" id="srcline623">623</a></span><span class="line">        assert(<span class="mxinfo" id="T6:U35">isequal(numerictype(<span class="var type1" id="S91T4U1187">max_voltage</span>), <span class="var type1" id="S94T5U1188">Fixed_Point_Properties</span>) &amp;&amp; isequal(fimath(<span class="var type1" id="S91T4U1193">max_voltage</span>), <span class="var type1" id="S97T7U1194">F</span>)</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,624" id="srcline624">624</a></span><span class="line">        assert(<span class="mxinfo" id="T6:U40">isequal(numerictype(<span class="var type1" id="S92T4U1203">pos_deviance_threshold</span>), <span class="var type1" id="S94T5U1204">Fixed_Point_Properties</span>) &amp;&amp; isequal(fimath(<span class="var type1" id="S92T4U1209">pos_deviance_threshold</span>), <span class="var type1" id="S97T7U1210">F</span>)</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,625" id="srcline625">625</a></span><span class="line">        assert(<span class="mxinfo" id="T6:U45">isequal(numerictype(<span class="var type1" id="S93T4U1219">neg_deviance_threshold</span>), <span class="var type1" id="S94T5U1220">Fixed_Point_Properties</span>) &amp;&amp; isequal(fimath(<span class="var type1" id="S93T4U1225">neg_deviance_threshold</span>), <span class="var type1" id="S97T7U1226">F</span>)</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,626" id="srcline626">626</a></span><span class="line">        <span class="mxinfo" id="T4:U50"><span class="var type1" id="S103T4U1229">noise_sum</span> = <span class="mxinfo" id="T4:U52">fi(0, <span class="var type1" id="S94T5U1233">Fixed_Point_Properties</span>, <span class="var type1" id="S97T7U1234">F</span>)</span></span>; <span class="mxinfo" id="T4:U55"><span class="var type1" id="S105T4U1237">signal_sum</span> = <span class="mxinfo" id="T4:U57">fi(0, <span class="var type1" id="S94T5U1241">Fixed_Point_Properties</span>, <span class="var type1" id="S97T7U1242">F</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,627" id="srcline627">627</a></span><span class="line">        <span class="mxinfo" id="T4:U60"><span class="var type1" id="S106T4U1245">noise_count</span> = <span class="mxinfo" id="T4:U62">fi(0, <span class="var type1" id="S94T5U1249">Fixed_Point_Properties</span>, <span class="var type1" id="S97T7U1250">F</span>)</span></span>; <span class="mxinfo" id="T4:U65"><span class="var type1" id="S107T4U1253">signal_count</span> = <span class="mxinfo" id="T4:U67">fi(0, <span class="var type1" id="S94T5U1257">Fixed_Point_Properties</span>, <span class="var type1" id="S97T7U1258">F</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,628" id="srcline628">628</a></span><span class="line">        <span class="mxinfo" id="T4:U70"><span class="var type1" id="S87T4U1261">noise_lvl</span> = <span class="mxinfo" id="T4:U72">fi(0, <span class="var type1" id="S94T5U1265">Fixed_Point_Properties</span>, <span class="var type1" id="S97T7U1266">F</span>)</span></span>; <span class="mxinfo" id="T4:U75"><span class="var type1" id="S88T4U1269">signal_lvl</span> = <span class="mxinfo" id="T4:U77">fi(0,<span class="var type1" id="S94T5U1273">Fixed_Point_Properties</span>, <span class="var type1" id="S97T7U1274">F</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,629" id="srcline629">629</a></span><span class="line">        <span class="keyword">for</span> <span class="var type1" id="S108T2U1277">index</span>=<span class="mxinfo" id="T2:U81">1</span>:<span class="mxinfo" id="T2:U82">length(<span class="var type1" id="S89T64U1282">R_peak_vals</span>)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,630" id="srcline630">630</a></span><span class="line">               <span class="comment">% DELETE AFTER DEBUGGING</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,631" id="srcline631">631</a></span><span class="line">               <span class="comment">%if (shouldPlot &amp;&amp; channel == 2)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,632" id="srcline632">632</a></span><span class="line">               <span class="comment">%    fprintf('The peak val is: %f\n',R_peak_vals(index));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,633" id="srcline633">633</a></span><span class="line">               <span class="comment">%end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,634" id="srcline634">634</a></span><span class="line">           <span class="keyword">if</span> (<span class="mxinfo" id="T6:U84"><span class="mxinfo" id="T4:U85"><span class="mxinfo" id="T4:U86"><span class="var type1" id="S89T64U1289">R_peak_vals</span>(<span class="var type1" id="S108T2U1290">index</span>)</span> * <span class="var type1" id="S91T4U1291">max_voltage</span></span> &gt; <span class="var type1" id="S90T4U1292">threshold</span></span>) </span></span>
<span class="srcline"><span class="lineno"><a href="1,635" id="srcline635">635</a></span><span class="line">               <span class="comment">%fprintf('mv: %f. Threshold is: %f\n', R_peak_vals(index) * max_voltage, threshold);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,636" id="srcline636">636</a></span><span class="line">               <span class="comment">%R_peak_vals(index)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,637" id="srcline637">637</a></span><span class="line">               <span class="comment">% Filters out any signal value which exceeds the allowed deviance from</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,638" id="srcline638">638</a></span><span class="line">               <span class="comment">% the average signal value </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,639" id="srcline639">639</a></span><span class="line">               <span class="keyword">if</span> (<span class="mxinfo" id="T6:U91">~<span class="mxinfo" id="T6:U92"><span class="fcn" id="F292N4:B1298">meets_deviance_threshold</span>(<span class="mxinfo" id="T4:U93"><span class="var type1" id="S89T64U1300">R_peak_vals</span>(<span class="var type1" id="S108T2U1301">index</span>)</span>, <span class="var type1" id="S88T4U1302">signal_lvl</span>, <span class="var type1" id="S92T4U1303">pos_deviance_threshold</span>, <span class="var type1" id="S93T4U1304">neg_deviance_threshold</span>)</span></span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,640" id="srcline640">640</a></span><span class="line">                  <span class="comment">%fprintf('%f, %f Does not meet the deviance threshold\n', R_peak_vals(index), signal_lvl);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,641" id="srcline641">641</a></span><span class="line">                   <span class="comment">% Sets all the indices which R_vals don't meet the threshold to 0</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,642" id="srcline642">642</a></span><span class="line">                   <span class="mxinfo" id="T2:U99"><span class="mxinfo" id="T2:U100"><span class="var type1" id="S86T65U1308">indices</span>(<span class="var type1" id="S108T2U1309">index</span>)</span> = <span class="mxinfo" id="T2:U103">0</span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="1,643" id="srcline643">643</a></span><span class="line">                   <span class="comment">% Updates the average noise signal lvl</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,644" id="srcline644">644</a></span><span class="line">                   <span class="mxinfo" id="T4:U104"><span class="var type1" id="S103T4U1313">noise_sum</span> = <span class="mxinfo" id="T4:U106"><span class="var type1" id="S103T4U1315">noise_sum</span>  + <span class="mxinfo" id="T4:U108"><span class="var type1" id="S89T64U1317">R_peak_vals</span>(<span class="var type1" id="S108T2U1318">index</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,645" id="srcline645">645</a></span><span class="line">                   <span class="mxinfo" id="T4:U111"><span class="var type1" id="S106T4U1321">noise_count</span> = <span class="mxinfo" id="T4:U113"><span class="var type1" id="S106T4U1323">noise_count</span> + 1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,646" id="srcline646">646</a></span><span class="line">                   <span class="comment">% Calculates the noise level</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,647" id="srcline647">647</a></span><span class="line"><span class="comment">%                    noise_lvl = noise_sum / noise_count;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,648" id="srcline648">648</a></span><span class="line">                   <span class="mxinfo" id="T4:U115"><span class="var type1" id="S87T4U1327">noise_lvl</span> = <span class="mxinfo" id="T4:U117">divide(<span class="var type1" id="S94T5U1330">Fixed_Point_Properties</span>, <span class="var type1" id="S103T4U1331">noise_sum</span>, <span class="var type1" id="S106T4U1332">noise_count</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,649" id="srcline649">649</a></span><span class="line">                   <span class="keyword">continue</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,650" id="srcline650">650</a></span><span class="line">               <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,651" id="srcline651">651</a></span><span class="line">               <span class="comment">% DELETE AFTER DEBUGGING</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,652" id="srcline652">652</a></span><span class="line">               <span class="comment">%if (shouldPlot &amp;&amp; channel == 2)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,653" id="srcline653">653</a></span><span class="line">               <span class="comment">%   fprintf('The peak val is: %f\n',R_peak_vals(index));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,654" id="srcline654">654</a></span><span class="line">               <span class="comment">%end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,655" id="srcline655">655</a></span><span class="line">                <span class="comment">% Updates the average signal lvl</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,656" id="srcline656">656</a></span><span class="line">               <span class="mxinfo" id="T4:U121"><span class="var type1" id="S105T4U1336">signal_sum</span> = <span class="mxinfo" id="T4:U123"><span class="var type1" id="S105T4U1338">signal_sum</span> + <span class="mxinfo" id="T4:U125"><span class="var type1" id="S89T64U1340">R_peak_vals</span>(<span class="var type1" id="S108T2U1341">index</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,657" id="srcline657">657</a></span><span class="line">               <span class="mxinfo" id="T4:U128"><span class="var type1" id="S107T4U1344">signal_count</span> = <span class="mxinfo" id="T4:U130"><span class="var type1" id="S107T4U1346">signal_count</span> + 1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,658" id="srcline658">658</a></span><span class="line">               <span class="comment">% Calculates the signal level</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,659" id="srcline659">659</a></span><span class="line"><span class="comment">%                signal_lvl = signal_sum / signal_count;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,660" id="srcline660">660</a></span><span class="line">               <span class="mxinfo" id="T4:U132"><span class="var type1" id="S88T4U1350">signal_lvl</span> = <span class="mxinfo" id="T4:U134">divide(<span class="var type1" id="S94T5U1353">Fixed_Point_Properties</span>, <span class="var type1" id="S105T4U1354">signal_sum</span>, <span class="var type1" id="S105T4U1355">signal_sum</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,661" id="srcline661">661</a></span><span class="line">           <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,662" id="srcline662">662</a></span><span class="line">               <span class="comment">% Sets all the indices which R_vals don't meet the threshold to 0</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,663" id="srcline663">663</a></span><span class="line">               <span class="mxinfo" id="T2:U138"><span class="mxinfo" id="T2:U139"><span class="var type1" id="S86T65U1360">indices</span>(<span class="var type1" id="S108T2U1361">index</span>)</span> = <span class="mxinfo" id="T2:U142">0</span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="1,664" id="srcline664">664</a></span><span class="line">               <span class="comment">% Updates the average noise signal lvl</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,665" id="srcline665">665</a></span><span class="line">               <span class="mxinfo" id="T4:U143"><span class="var type1" id="S103T4U1365">noise_sum</span> = <span class="mxinfo" id="T4:U145"><span class="var type1" id="S103T4U1367">noise_sum</span>  + <span class="mxinfo" id="T4:U147"><span class="var type1" id="S89T64U1369">R_peak_vals</span>(<span class="var type1" id="S108T2U1370">index</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,666" id="srcline666">666</a></span><span class="line">               <span class="mxinfo" id="T4:U150"><span class="var type1" id="S106T4U1373">noise_count</span> = <span class="mxinfo" id="T4:U152"><span class="var type1" id="S106T4U1375">noise_count</span> + 1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,667" id="srcline667">667</a></span><span class="line">               <span class="comment">% Calculates the noise level</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,668" id="srcline668">668</a></span><span class="line"><span class="comment">%                noise_lvl = noise_sum / noise_count;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,669" id="srcline669">669</a></span><span class="line">               <span class="mxinfo" id="T4:U154"><span class="var type1" id="S87T4U1379">noise_lvl</span> = <span class="mxinfo" id="T4:U156">divide(<span class="var type1" id="S94T5U1382">Fixed_Point_Properties</span>, <span class="var type1" id="S103T4U1383">noise_sum</span>, <span class="var type1" id="S106T4U1384">noise_count</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,670" id="srcline670">670</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,671" id="srcline671">671</a></span><span class="line">           <span class="keyword">end</span>          </span></span>
<span class="srcline"><span class="lineno"><a href="1,672" id="srcline672">672</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,673" id="srcline673">673</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,674" id="srcline674">674</a></span><span class="line">    </span></span>
</pre>
